<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Usuario</title>
    <link rel="shortcut icon" href="img/minilogo.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <style>
        .input-group {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: -10px;
            top: 70%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
        }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      // Importación de Firestore
      import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

      // Tu configuración de Firebase (asegúrate de que sea la misma que en ingresar.html)
      const firebaseConfig = {
        apiKey: "AIzaSyDfJ0fZ30u3RIWjWBRMCMepSoC9P881K3E",
        authDomain: "ralph-s-sangucheria.firebaseapp.com",
        projectId: "ralph-s-sangucheria",
        storageBucket: "ralph-s-sangucheria.firebasestorage.app",
        messagingSenderId: "795336985600",
        appId: "1:795336985600:web:66eef18a4eaba9a9bc5ce5",
        measurementId: "G-TFW57TXCPR"
      };

      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      // Inicializa Firestore
      const db = getFirestore(app);

      document.addEventListener('DOMContentLoaded', function() {
        const registerForm = document.getElementById("registerForm");
        const newUsernameInput = document.getElementById("newUsername");
        const newPasswordInput = document.getElementById("newPassword");
        const usernameError = document.getElementById("usernameError");
        const passwordError = document.getElementById("passwordError");
        const userExists = document.getElementById("userExists");
        const registerMessage = document.getElementById("registerMessage"); // Agregamos este ID para mensajes de éxito
        const togglePassword = document.getElementById("togglePassword");

        // Función para mostrar mensajes de éxito o error
        const showMessage = (element, message, isError = false) => {
            element.textContent = message;
            element.style.display = 'block';
            element.style.color = isError ? '#f44336' : '#4CAF50';
            // Ocultamos los otros mensajes para evitar conflictos
            if (isError) {
                if (element.id !== 'usernameError') usernameError.style.display = 'none';
                if (element.id !== 'passwordError') passwordError.style.display = 'none';
                if (element.id !== 'userExists') userExists.style.display = 'none';
                if (element.id !== 'registerMessage') registerMessage.style.display = 'none';
            } else {
                usernameError.style.display = 'none';
                passwordError.style.display = 'none';
                userExists.style.display = 'none';
            }
        };

        registerForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          const email = newUsernameInput.value.trim();
          const password = newPasswordInput.value.trim();

          // Limpiar mensajes anteriores
          usernameError.style.display = "none";
          passwordError.style.display = "none";
          userExists.style.display = "none";
          registerMessage.style.display = "none";

          if (email === "") {
            showMessage(usernameError, "El correo electrónico es obligatorio", true);
            return;
          }

          if (password === "") {
            showMessage(passwordError, "La contraseña es obligatoria", true);
            return;
          }

          try {
            // 1. Crear el usuario en Firebase Authentication
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Guardar los datos del usuario en Firestore
            await setDoc(doc(db, "usuarios", email), {
                email: user.email,
                uid: user.uid,
                creado: serverTimestamp()
            });

            // 3. Mostrar mensaje de éxito y redirigir
            showMessage(registerMessage, "¡Registro exitoso! Redirigiendo...", false);
            setTimeout(() => {
                window.location.href = "ingresar.html";
            }, 2000); // Redirige después de 2 segundos

          } catch (error) {
            console.error("Error al registrar usuario:", error);
            if (error.code === 'auth/email-already-in-use') {
              showMessage(userExists, "Este correo electrónico ya está en uso", true);
            } else if (error.code === 'auth/invalid-email') {
              showMessage(usernameError, "El formato del correo electrónico no es válido", true);
            } else if (error.code === 'auth/weak-password') {
              showMessage(passwordError, "La contraseña debe tener al menos 6 caracteres", true);
            } else {
              alert("Ocurrió un error al registrar el usuario: " + error.message);
            }
          }
        });

        if (togglePassword) {
            togglePassword.addEventListener('click', function() {
                const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                newPasswordInput.setAttribute('type', type);
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
            });
        }
      });
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
      <h2>Registrar Usuario</h2>
      <form id="registerForm">
          <div class="input-group">
              <label for="newUsername">Correo Electrónico</label>
              <input type="email" id="newUsername" placeholder="Ingresa tu correo electrónico" required>
              <p id="usernameError" class="error-message">El correo electrónico es obligatorio</p>
              <p id="userExists" class="error-message">Este correo electrónico ya está en uso</p>
          </div>
          <div class="input-group">
              <label for="newPassword">Contraseña</label>
              <input type="password" id="newPassword" placeholder="Ingresa tu nueva contraseña" required>
              <i id="togglePassword" class="fas fa-eye toggle-password"></i>
              <p id="passwordError" class="error-message">La contraseña es obligatoria</p>
          </div>
            <p id="registerMessage" class="success-message" style="display: none;"></p> <button type="submit">Registrar</button>
        </form>
        <div class="options">
            <a href="ingresar.html">¿Ya tienes una cuenta? Inicia sesión</a>
        </div>
    </div>
</body>
</html>